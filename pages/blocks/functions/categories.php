<?

/////////////////////////////////////
//       Category Functions
/////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		get_all_categories ()
//
//		returns all the categories
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function get_first_category_alphabetically () {
    $db = $GLOBALS["db"];
    // get the data from the DB
    $result = mysqli_query ($db, 'SELECT *
                                    FROM categories
                                    ORDER BY name ASC
                                    LIMIT 1');

    // if there was an error
    if (!$result) {
        $error = "<p>get_first_category_alphabetically (): Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);

        if ($GLOBALS["debug_mode"]==1) {
            echo show_error($error);
        }
    }

    // if nothing returned
    else if (mysqli_num_rows($result)>0) {
        $tmp = mysqli_fetch_array($result);
        return $tmp;
    }
    // if nothing returned
    else {
        return 0;
    }
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		get_all_categories ()
//
//		returns all the categories
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function get_all_categories () {
	$db = $GLOBALS["db"];
	// get the data from the DB
	$result = mysqli_query ($db, "SELECT * FROM categories ORDER BY name");
	
	// if there was an error
	if (!$result) {
		$error = "<p>get_all_categories (): Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
		
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error);
		}
	}
	
	// if nothing returned
	if (mysqli_num_rows($result)>0) {
		return $result;
	}
	// if nothing returned
	else {
		return 0;
	}
}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		get_category_name ($category_id)
//
//		returns category name
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function get_category_name ($category_id) {
	$db = $GLOBALS["db"];
	// get the data from the DB
	$result = mysqli_query ($db, "SELECT name FROM categories WHERE id = '$category_id'");
	
	// if there was an error
	if (!$result) {
		$error = "<p>get_all_categories (): Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
		
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error);
		}
		
		return 0;
	}
	
	// if nothing returned
	if (mysqli_num_rows($result)>0) {
		$data = mysqli_fetch_array($result);	
		return $data['name'];
	}
	// if nothing returned
	else {
		return 0;
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		get_category_id ($name)
//
//		returns category id
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_category_id ($name) {
	$db = $GLOBALS["db"];
	// get the data from the DB
	$result = mysqli_query ($db, "SELECT id FROM categories WHERE name='$name' ORDER BY id DESC LIMIT 1");
	
	// if there was an error
	if (!$result) {
		$error = "<p>get_category_id (): Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
		
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error);
		}
	}
	
	// if nothing returned
	if (mysqli_num_rows($result)>0) {
		$tmp = mysqli_fetch_array ($result);
		return $tmp['id'];
	}
	// if nothing returned
	else {
		return 0;
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		add_category ($name)
//
//		returns category id
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function add_category ($name) {
		$db = $GLOBALS["db"];
		/* all ok -> sqlquery */
		
		$result = mysqli_query ($db, "INSERT INTO categories (`name`) VALUES ('$name')");
		
		return $result;
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		update_category ($name)
//
//		returns category id
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function update_category ($id, $name) {
		$db = $GLOBALS["db"];
		/* all ok -> sqlquery */
		
		$result = mysqli_query ($db, "UPDATE  categories SET `name` =  '$name' WHERE `id` = '$id'");
				
		if ($result) {
			$error = show_error("Названия категории было удачно изменено на <strong>$name</strong>", "success", 0);
			$footer_links = "<p class='clear'>
								<a class='fl_left' href='categories.php?id=".$id."'>&laquo; Назад</a>
								<a class='fl_right' href='index.php'>На Главную &raquo;</a>
							</p>";
						
			$url = "categories.php?id=".$id;
			echo "<meta http-equiv='refresh' content='0; URL=$url'>";
			
			
		}
		else {
			$mysqli_error = mysqli_error($db);
			$error =  show_error("Названия категории <strong>\"$name\"</strong> не было изменено! <br> <br><strong>причина</strong>:<br>$mysqli_error");
			$footer_links = "<p class='clear'>
								<a class='fl_left' href='javascript:history.go(-1)'>&laquo; Назад</a>
							</p>";
		}
		
		return $error;
}
	
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		category_exists ($id)
//
//		returns category id
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function category_exists ($id) {
	$db = $GLOBALS["db"];
	// get the data from the DB
	$result = mysqli_query ($db, "SELECT * FROM categories WHERE id='$id'");
	
	// if there was an error
	if (mysqli_num_rows($result)>0) {
		return true;
	}
	else {
		return false;
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		category_empty ($id)
//
//		returns category id
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function category_empty ($id) {
	$db = $GLOBALS["db"];
	// get the data from the DB
	$result = mysqli_query ($db, "SELECT count(id) as num FROM products WHERE category_id='$id'");
	
	// if there was an error
	if (!$result) {
		$error = "<p>category_empty (): Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
		
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error);
		}
	}
	
	$tmp = mysqli_fetch_array($result);
	// if not empty
	if ($tmp['num']>0) {
		return 0;
	}
	else {
		return 1;
	}
}


?>