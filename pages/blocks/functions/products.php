<?

/////////////////////////////////////
//       Products Functions
/////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		get_all_products ()
//
//		returns all the products in array
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function get_all_products () {
	$db = $GLOBALS["db"];
	
	// get the data from the DB
	$result = mysqli_query ($db, "SELECT * FROM products");
	
	// if there was an error
	if (!$result) {
		$error = "<p>get_all_products (): Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
		
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error);
		}
	}
	
	// if nothing returned
	if (mysqli_num_rows($result)>0) {
		return $result;
	}
	// if nothing returned
	else {
		return 0;
	}
}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		add_location_product ($location_id, $product_id, $amount, $price, $amount)
//
//		returns last_transaction
//

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function add_location_product ($location_id, $product_id, $price, $amount) {
	$db = $GLOBALS["db"];
	// get the data from the DB
	$result = mysqli_query ($db, "INSERT INTO `location_products` (`location_id`, `product_id`, `price`, `amount`) VALUES ('$location_id', '$product_id', '$price', '$amount')");
	$error = "";
	// if there was an error
	if (!$result) {
		$error = "<p>add_location_product (): Error adding data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
		//$error = $error."<p>Values recieved: location_id=$location_id, product_id=$product_id, amount=$amount, price=$price</p>";
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error);
		}
		
		return false;
	}
	else {
		//$error = $error."<p>add_location_product() : Values recieved: location_id=$location_id, product_id=$product_id, price=$price</p>";
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error, "succeess");
		}
		return true;
	}
}

    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //
    //		add_product ($location_id, $product_id, $amount, $price, $amount)
    //
    //		returns last_transaction
    //

    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    function add_product ($category_id, $name) {
        $db = $GLOBALS["db"];
        // get the data from the DB
        $result = mysqli_query ($db, "INSERT INTO products (`category_id`, `name`) VALUES ('$category_id', '$name');");
        $error = "";
        // if there was an error
        if (!$result) {
            $error = "<p>add_product (): Error adding data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
            //$error = $error."<p>Values received: location_id=$location_id, product_id=$product_id, amount=$amount, price=$price</p>";
            if ($GLOBALS["debug_mode"]==1) {
                echo show_error($error);
            }
            return 0;
        }
        else {
            //$error = $error."<p>add_location_product() : Values received: location_id=$location_id, product_id=$product_id, price=$price</p>";
            if ($GLOBALS["debug_mode"]==1) {
                echo show_error($error, "success");
            }

            // get the last entered product's id
            $last_id = get_last_product_id();
            return $last_id;
        }
    }

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		add_zero_amount_to_all ($id)
//
//		adds zeros to location_products table for the product
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function add_zero_amount_to_all ($id) {
	$db = $GLOBALS["db"];
	$res =  get_all_locations();
	
	$locations = mysqli_fetch_array ($res);
	
	do {
		$location_id = $locations['id'];
		$result2 = mysqli_query ($db, "INSERT INTO location_products (`product_id`, `location_id`, `amount`)  VALUES ('$id', '$location_id', '0');");
		
		if(!$result2) {
			$error = "Error in add_zero_amount_to_all () while adding to location <strong>".$location_id."</strong>: Error code:</strong>".mysqli_error($db);
			
			return show_error($error);
		}

	}while ($locations = mysqli_fetch_array ($res));
	
	
	return show_error("add_zero_amount_to_all - Done!", "success", 0);
}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		get_last_product_id ()
//
//		returns product id
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_last_product_id () {
    $db = $GLOBALS["db"];
    // get the data from the DB
    $result = mysqli_query ($db, "SELECT id FROM products ORDER BY id DESC LIMIT 1");
    // if there was an error
    if (!$result) {
        $error = "<p>get_last_product_id (): Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);

        if ($GLOBALS["debug_mode"]==1) {
            echo show_error($error);
        }
    }

    // if nothing returned
    if (mysqli_num_rows($result)>0) {
        $tmp = mysqli_fetch_array ($result);
        return $tmp['id'];
    }

    // if nothing returned
    else {
        return 0;
    }
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		get_product_id ($name)
//
//		returns product id
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function get_product_id ($name) {
	$db = $GLOBALS["db"];
	// get the data from the DB
	$result = mysqli_query ($db, "SELECT id FROM products WHERE name='$name' ORDER BY id DESC LIMIT 1");
	
	// if there was an error
	if (!$result) {
		$error = "<p>get_product_id (): Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
		
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error);
		}
	}
	
	// if nothing returned
	if (mysqli_num_rows($result)>0) {
		$tmp = mysqli_fetch_array ($result);
		return $tmp['id'];
	}
	// if nothing returned
	else {
		return 0;
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		get_all_products_orderby_category_id ()
//
//		returns all the products in array
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function get_all_products_orderby_category_id () {
	$db = $GLOBALS["db"];
	
	// get the data from the DB
	$result = mysqli_query ($db, "SELECT * FROM products ORDER BY category_id");
	
	// if there was an error
	if (!$result) {
		$error = "<p>get_all_products_orderby_category_id (): Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
		
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error);
		}
	}
	
	// if nothing returned
	if (mysqli_num_rows($result)>0) {
		return $result;
	}
	// if nothing returned
	else {
		return 0;
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		get_all_products_orderby_category_id ()
//
//		returns all the products in array
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function get_all_products_and_locations_from_category ($category_id) {
	$db = $GLOBALS["db"];
	// get the data from the DB
	$result = mysqli_query ($db, "SELECT location_id, product_id, name, location_products.price, amount
							FROM location_products, products
							WHERE product_id = id AND category_id = $category_id
							ORDER BY location_products.product_id");
							
	// if there was an error
	if (!$result) {
		$error = "<p>get_all_products_and_locations_from_category (): Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
		
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error);
		}
	}
	
	// if nothing returned
	if (mysqli_num_rows($result)>0) {
		return $result;
	}
	// if nothing returned
	else {
		return 0;
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		get_all_products_from_category ($category_id)
//
//		returns all the products in array
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function get_all_products_from_category ($category_id) {
	$db = $GLOBALS["db"];
	
	// get the data from the DB
	$result = mysqli_query ($db, "SELECT * FROM products WHERE category_id = '$category_id' ORDER BY name ASC ");
	
	// if there was an error
	if (!$result) {
		$error = "<p>get_all_products_from_category (): Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
		
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error);
		}
	}
	
	// if nothing returned
	if (mysqli_num_rows($result)>0) {
		return $result;
	}
	// if nothing returned
	else {
		return 0;
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		get_product_amount_per_location ($products_id, $location_id)
//
//		returns product amount per location
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function get_product_amount_per_location ($product_id, $location_id) {
	$db = $GLOBALS["db"];
	// get the data from the DB
	$result = mysqli_query ($db, "SELECT amount FROM location_products WHERE product_id = '$product_id' AND location_id = '$location_id'");

    //echo show_error("product_id: $product_id | location_id: $location_id","info",1);
	// if there was an error
	if (!$result) {
		
		$error = "<p>get_product_amount_per_location (): Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
		
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error);
		}
		
		return 0;
	}
	
	// if nothing returned
	if (mysqli_num_rows($result)>0) {
		$data = mysqli_fetch_array($result);	
		return $data['amount'];
	}
	// if nothing returned
	else {
		return 0;
	}
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		get_product_return_amount ($product_id, $location_id)
//
//		returns product return amount per location
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function get_all_return_transactions_by_location ($product_id, $location_id, $date = "thisMonth") {
	$db = $GLOBALS["db"];
	
	if ($date == "thisMonth") {
		$date = date("Y-m");
	}
	$date_begin = $date;
	$date++;
	$date_end = $date;
	
	$date_begin = $date_begin."-01";
	$date_end = $date_end."-01";
	
		$res1 = mysqli_query ($db, "SELECT  `id`
								FROM  `transactions`
								WHERE  `from_location` = $location_id
								AND  `to_location` =0
								AND  `date` >=  '$date_begin'
								AND  `date` <  '$date_end'");
		
	// if there was an error
	if (!$res1) {
		
		$error = "<p>get_product_return_amount () res1: Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
			
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error);
		}
		
		return 0;
	}
	if (mysqli_num_rows($res1)>0) {
		
		$data1 = mysqli_fetch_array($res1);
		$returns = "";
		$i=0;
		do {
			if ($i==0) $returns = $returns.$data1['id'];
			else $returns = $returns.", ".$data1['id'];
			$i++;
		}while($data1 = mysqli_fetch_array($res1));
		return $returns;
	}
	else {
		return 0;
	}
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		get_product_return_amount ($product_id, $location_id)
//
//		returns product return amount per location
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /**
     * @param        $product_id
     * @param        $location_id
     *
     * @return int
     */
    function get_product_return_amount ($product_id, $location_id) {
	$db = $GLOBALS["db"];
	
	$returns = get_all_return_transactions_by_location ($product_id, $location_id);
	// get the data from the DB
	
	$result = mysqli_query ($db, "SELECT SUM(`amount`) as `return_amount`
							FROM `transaction_products`
							WHERE `product_id`='$product_id'
							AND `transaction_id`
							IN ($returns)");
	
	// if there was an error
	if (!$result) {
		
		$error = "<p>get_product_return_amount () result: Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
		
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error);
		}
		
		return 0;
	}
	
	if (mysqli_num_rows($result)>0) {
		$data = mysqli_fetch_array($result);
        if ($GLOBALS["debug_mode"]==1) {
            echo "= -".$data['return_amount'];
        }
		return $data['return_amount'];

	}
	// if nothing returned
	else {
		return 0;
	}
}
/*




*/
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		get_all_locations_by_product ($products_id)
//
//		returns product amount per location
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function get_all_locations_by_product ($products_id) {
	$db = $GLOBALS["db"];
	// get the data from the DB
	$result = mysqli_query ($db, "SELECT  `location_id` ,  `product_id` ,  `amount`, `price`
							FROM  `location_products`
							WHERE  `product_id` = $products_id");
	
	// if there was an error
	if (!$result) {
		
		$error = "<p>get_all_locations_by_product (): Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
		
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error);
		}
		
		return 0;
	}
	
	// if nothing returned
	if (mysqli_num_rows($result)>0) {	
		return $result;
	}
	// if nothing returned
	else {
		return 0;
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		product_exists ($id)
//
//		returns category id
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function product_exists ($id) {
	$db = $GLOBALS["db"];
	// get the data from the DB
	$result = mysqli_query ($db, "SELECT * FROM products WHERE id='$id'");
	
	// if there was an error
	if (mysqli_num_rows($result)>0) {
		return true;
	}
	else {
		return false;
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		get_product_details ($product_id)
//
//		returns product details
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function get_product_details ($product_id) {
	$db = $GLOBALS["db"];
	// get the data from the DB
	$result = mysqli_query ($db, "SELECT * FROM products WHERE id = '$product_id'");
	
	// if there was an error
	if (!$result) {
		$error = "<p>get_product_details (): Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
		
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error);
		}
		
		return 0;
	}
	
	// if nothing returned
	if (mysqli_num_rows($result)>0) {
		$tmp = mysqli_fetch_array ($result);
		return $tmp;
	}
	// if nothing returned
	else {
		return 0;
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		get_product_name ($product_id)
//
//		returns product details
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function get_product_name ($product_id) {
	$db = $GLOBALS["db"];
	// get the data from the DB
	$result = mysqli_query ($db, "SELECT name FROM products WHERE id = '$product_id'");
	
	// if there was an error
	if (!$result) {
		$error = "<p>get_product_details (): Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
		
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error);
		}
		
		return 0;
	}
	
	// if nothing returned
	if (mysqli_num_rows($result)>0) {
		$tmp = mysqli_fetch_array ($result);
		return $tmp['name'];
	}
	// if nothing returned
	else {
		return 0;
	}
}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		delete_product ($id) 
//
//		returns location name
//

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function delete_product ($id) {
	$db = $GLOBALS["db"];
	/* all ok -> sqlquery */
	
	$product = get_product_details($id);
	$result1 = mysqli_query ($db, "DELETE FROM location_products WHERE `product_id` = '$id'");
	if ($result1) {
		$error = "<p>Информация о продуктах по филиалам \"<strong>".$product['name']."</strong>\" была успешно удалена!</p>";
		$result2 = mysqli_query ($db, "DELETE FROM products WHERE `id` = '$id'");

        clearEmptyTransactionProducts();
        clearEmptyTransactions ();
		
		if ($result2) {
			$error = show_error($error."<p>Продукт \"<strong>".$product['name']."</strong>\" был успешно удален!</p>", "success", 0);
			
			//echo "<meta http-equiv='refresh' content='0;URL=categories.php?id=".$product['category_id']."'>";
		}
		else {
			$mysql_error = mysqli_error($db);
			$error = show_error($error."Продукт \"<strong>".$product['name']."</strong>\" был успешно удален!", "success", 0);
	
			//echo "<meta http-equiv='refresh' content='0;URL=categories.php?id=".$product['category_id']."'>";
		}
		
		return $error;
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//		update_product_amount ($location_id, $product_id, $amount) 
//
//		returns last_transaction
//

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function update_product_amount ($location_id, $product_id, $amount) {
	$db = $GLOBALS["db"];
	$previousAmount = get_product_amount_per_location ($product_id, $location_id);
	$location_name 	= get_location_name	($location_id);
	$product_name 	= get_product_name	($product_id);
	$result = mysqli_query ($db, "UPDATE  location_products
							SET  `amount` =  '$amount'
							WHERE  `product_id` = '$product_id' AND  `location_id` = '$location_id';");
	
	// if there was an error
	if (!$result) {
		$error = "<p>update_product_amount (): Error while retrieving data from the DB. Please notify the administrator on support@freeurmind.net<br><strong>Error code:</strong></p>".mysqli_error($db);
		
		if ($GLOBALS["debug_mode"]==1) {
			echo show_error($error);
		}
		
		return false;
	}
	else {
		$error = "<p>update_product_amount (): </p>
					<p>The amount of <strong>$product_name</strong> in <strong>$location_name</strong>
					 changed from <strong>$previousAmount</strong> to <strong>$amount</strong></p>";

        if ($GLOBALS["debug_mode"]==1) {
            echo show_error ($error, "success", 1);
        }
		return true;
	}
}

?>